--#SET TERMINATOR @

------------------------------------------------------------
-- Sanity check :)
------------------------------------------------------------

SELECT name, value
FROM sysibmadm.dbcfg
WHERE name IN ('codeset','codepage')@

------------------------------------------------------------
-- 1.  SCHEMA & TABLES
------------------------------------------------------------
CREATE SCHEMA REPO AUTHORIZATION REPO@
SET CURRENT SCHEMA REPO@

------------------------------------------------------------
-- Tenants
------------------------------------------------------------
CREATE TABLE REPO_TENANT
(
    TENANTID    INT           NOT NULL,
    NAME        VARCHAR(256)  NOT NULL,
    DESCRIPTION CLOB(1 M),
    CREATED     TIMESTAMP     NOT NULL DEFAULT CURRENT TIMESTAMP,
    CONSTRAINT REPO_TENANT_PK PRIMARY KEY (TENANTID),
    CONSTRAINT REPO_TENANT_NAME_UQ UNIQUE (NAME)
)@

------------------------------------------------------------
-- Unit entities
------------------------------------------------------------
CREATE TABLE REPO_UNIT_KERNEL
(
    TENANTID INT                 NOT NULL,
    UNITID   BIGINT GENERATED BY DEFAULT AS IDENTITY,
    CORRID   CHAR(36)            NOT NULL,
    STATUS   INT                 NOT NULL DEFAULT 30,
    LASTVER  INT                 NOT NULL DEFAULT 1,
    CREATED  TIMESTAMP           NOT NULL DEFAULT CURRENT TIMESTAMP,
    CONSTRAINT REPO_UNIT_KERNEL_PK PRIMARY KEY (TENANTID, UNITID),
    CONSTRAINT REPO_UNIT_KERNEL_CORRID_UQ UNIQUE (CORRID),
    CONSTRAINT REPO_UNIT_KERNEL_TENANT_FK FOREIGN KEY (TENANTID)
        REFERENCES REPO_TENANT (TENANTID)
)@

CREATE INDEX REPO_UK_IND1
    ON REPO_UNIT_KERNEL (TENANTID, UNITID, STATUS, CREATED DESC)@

CREATE INDEX REPO_UK_IND2
    ON REPO_UNIT_KERNEL (TENANTID, UNITID, LASTVER)@



CREATE TABLE REPO_UNIT_VERSION (
    TENANTID     INT        NOT NULL,
    UNITID       BIGINT     NOT NULL,
    UNITVER      INTEGER    NOT NULL,

    UNITNAME     VARCHAR(255),
    MODIFIED     TIMESTAMP  NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT REPO_UNIT_VERSION_PK
        PRIMARY KEY (TENANTID, UNITID, UNITVER),
    CONSTRAINT REPO_UNIT_VERSION_KRNL_EXISTS
        FOREIGN KEY (TENANTID, UNITID) REFERENCES REPO_UNIT_KERNEL (TENANTID, UNITID) ON DELETE CASCADE
)@

CREATE INDEX REPO_UV_IND1
    ON REPO_UNIT_VERSION (TENANTID, UNITID, UNITVER, MODIFIED)@

CREATE INDEX repo_uv_ind2
    ON REPO_UNIT_VERSION (TENANTID, LOWER(UNITNAME), UNITID, UNITVER)@

------------------------------------------------------------
-- Attribute catalogue
------------------------------------------------------------
CREATE TABLE REPO_NAMESPACE
(
    ALIAS     VARCHAR(128) NOT NULL,
    NAMESPACE VARCHAR(512) NOT NULL,
    CONSTRAINT REPO_NAMESPACE_PK PRIMARY KEY (ALIAS, NAMESPACE)
)@

CREATE TABLE REPO_ATTRIBUTE
(
    ATTRID      INT GENERATED BY DEFAULT AS IDENTITY,
    QUALNAME    VARCHAR(512)    NOT NULL,
    ATTRNAME    VARCHAR(256)    NOT NULL,
    ALIAS       VARCHAR(256),
    ATTRTYPE    INT             NOT NULL,
    SCALAR      BOOLEAN         NOT NULL DEFAULT FALSE,
    CREATED     TIMESTAMP       NOT NULL DEFAULT CURRENT TIMESTAMP,
    CONSTRAINT  REPO_ATTRIBUTE_PK PRIMARY KEY (ATTRID),
    CONSTRAINT  REPO_ATTRIBUTE_QUAL_UQ UNIQUE (QUALNAME),
    CONSTRAINT  REPO_ATTRIBUTE_NAME_UQ UNIQUE (ATTRNAME)
)@

CREATE TABLE REPO_ATTRIBUTE_DESCRIPTION
(
    ATTRID      INT         NOT NULL,
    LANG        CHAR(2)     NOT NULL DEFAULT 'SE',
    ALIAS       VARCHAR(256)NOT NULL,
    DESCRIPTION CLOB(1 M),
    CONSTRAINT  REPO_ATTR_DESC_PK PRIMARY KEY (ATTRID, LANG),
    CONSTRAINT  REPO_ATTR_DESC_ATTR_FK FOREIGN KEY (ATTRID)
        REFERENCES REPO_ATTRIBUTE (ATTRID)
)@

------------------------------------------------------------
-- Attribute value instances (1 per attribute within a unit)
------------------------------------------------------------
CREATE TABLE REPO_ATTRIBUTE_VALUE (
    TENANTID INT    NOT NULL,
    UNITID   BIGINT NOT NULL,
    ATTRID   INT    NOT NULL,
    VALUEID  BIGINT GENERATED BY DEFAULT AS IDENTITY,

    UNITVERFROM INTEGER NOT NULL DEFAULT 1,
    UNITVERTO   INTEGER NOT NULL DEFAULT 1,

    CONSTRAINT REPO_ATTRIBUTE_VALUE_PK
        PRIMARY KEY (TENANTID, UNITID, ATTRID, VALUEID, UNITVERFROM),
    CONSTRAINT REPO_ATTRIBUTE_VALUE_ID_UNIQUE
        UNIQUE (VALUEID),
    CONSTRAINT REPO_ATTRIBUTE_VALUE_ATTR_EX
        FOREIGN KEY (ATTRID) REFERENCES REPO_ATTRIBUTE (ATTRID),
    CONSTRAINT REPO_ATTRIBUTE_VALUE_UNIT_EX1
        FOREIGN KEY (TENANTID, UNITID, UNITVERFROM) REFERENCES REPO_UNIT_VERSION (TENANTID, UNITID, UNITVER) ON DELETE CASCADE,
    CONSTRAINT REPO_ATTRIBUTE_VALUE_UNIT_EX2
        FOREIGN KEY (TENANTID, UNITID, UNITVERTO) REFERENCES REPO_UNIT_VERSION (TENANTID, UNITID, UNITVER) ON DELETE CASCADE
)@

CREATE INDEX REPO_AV_IND1 ON REPO_ATTRIBUTE_VALUE (ATTRID)@

CREATE INDEX repo_av_ind2
    ON repo_attribute_value (tenantid, unitid, attrid, unitverfrom, unitverto)@


------------------------------------------------------------
-- Unit templates (metadata)
------------------------------------------------------------
CREATE TABLE REPO_UNIT_TEMPLATE (
    TEMPLATEID INT GENERATED BY DEFAULT AS IDENTITY,
    NAME       VARCHAR(256) NOT NULL,

    CONSTRAINT REPO_UNIT_TEMPLATE_PK
        PRIMARY KEY (TEMPLATEID),
    CONSTRAINT REPO_UNIT_TEMPLATE_NAME_UQ
        UNIQUE (NAME)
)@

CREATE TABLE REPO_UNIT_TEMPLATE_ELEMENTS (
    TEMPLATEID INT  NOT NULL,
    ATTRID     INT  NOT NULL,
    IDX        INT  NOT NULL,
    ALIAS      VARCHAR(256) NOT NULL,

    CONSTRAINT REPO_UNIT_TEMPLATE_ELEMENTS_PK
        PRIMARY KEY (TEMPLATEID, ATTRID),
    CONSTRAINT REPO_UNIT_TEMPLATE_ELEMENTS_TMP_EX
        FOREIGN KEY (TEMPLATEID) REFERENCES REPO_UNIT_TEMPLATE (TEMPLATEID) ON DELETE CASCADE
)@


------------------------------------------------------------
-- Record template (nested structures)
------------------------------------------------------------
CREATE TABLE repo_record_template (
    RECORDID  INT NOT NULL,
    NAME      VARCHAR(256) NOT NULL,

    CONSTRAINT REPO_RECORD_TEMPLATE_PK
        PRIMARY KEY (RECORDID),
    CONSTRAINT REPO_RECORD_TEMPLATE_NAME_UQ
        UNIQUE (NAME),
    CONSTRAINT REPO_RECORD_TEMPLATE_ID_EX
        FOREIGN KEY (RECORDID) REFERENCES REPO_ATTRIBUTE(ATTRID)
)@

CREATE TABLE repo_record_template_elements (
    RECORDID    INT  NOT NULL,
    ATTRID      INT  NOT NULL,

    IDX         INT  NOT NULL,
    ALIAS       VARCHAR(256),

    CONSTRAINT REPO_RECORD_TEMPLATE_ELEMENTS_PK
       PRIMARY KEY (RECORDID, ATTRID),
    CONSTRAINT REPO_RECORD_TEMPLATE_ELEMENTS_ID_EX
       FOREIGN KEY (ATTRID) REFERENCES REPO_ATTRIBUTE(ATTRID),
    CONSTRAINT REPO_RECORD_TEMPLATE_ELEMENTS_RCRD_EX
       FOREIGN KEY (RECORDID) REFERENCES REPO_RECORD_TEMPLATE (RECORDID) ON DELETE CASCADE
)@

------------------------------------------------------------
-- Vector tables (seven primitive types + record)
------------------------------------------------------------
CREATE TABLE REPO_STRING_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VALUE   VARCHAR(512),
    CONSTRAINT REPO_STRING_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_SV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE INDEX REPO_SV_IDX1 ON REPO_STRING_VECTOR ( LOWER(VALUE) )@

CREATE INDEX REPO_SV_IDX2 ON REPO_STRING_VECTOR
    ( VALUEID, LOWER(VALUE) )@

CREATE TABLE REPO_TIME_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VALUE   TIMESTAMP,
    CONSTRAINT REPO_TIME_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_TV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE INDEX REPO_TV_IDX1 ON REPO_TIME_VECTOR (VALUE)@

CREATE TABLE REPO_INTEGER_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VALUE   INT,
    CONSTRAINT REPO_INT_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_IV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE TABLE REPO_LONG_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VALUE   BIGINT,
    CONSTRAINT REPO_LONG_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_LV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE TABLE REPO_DOUBLE_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VALUE   DOUBLE,
    CONSTRAINT REPO_DOUBLE_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_DV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE TABLE REPO_BOOLEAN_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VALUE   BOOLEAN,
    CONSTRAINT REPO_BOOL_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_BV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE TABLE REPO_DATA_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VALUE   BLOB(1 M),
    CONSTRAINT REPO_DATA_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_DAV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE TABLE REPO_RECORD_VECTOR (
    valueid     BIGINT NOT NULL,           -- parent value vector
    idx         INT    NOT NULL DEFAULT 0, -- position within parent

    ref_attrid  INT    NOT NULL,
    ref_valueid BIGINT NULL,               -- initially null when first written, later updated

    CONSTRAINT REPO_RECORD_VECTOR_PK
        PRIMARY KEY (valueid, idx),
    CONSTRAINT REPO_RECORD_VEC_PARENT_EX
        FOREIGN KEY (valueid) REFERENCES REPO_ATTRIBUTE_VALUE(valueid) ON DELETE CASCADE,
    CONSTRAINT REPO_RECORD_VEC_CHILD_EX
        FOREIGN KEY (ref_valueid) REFERENCES REPO_ATTRIBUTE_VALUE(valueid) ON DELETE CASCADE
)@


-- Relevant when resolving placeholders (child -> parent),
-- i.e. when querying "WHERE ref_valueid = ?child?"
-- A fill factor of 80-90% is a reasonable starting point for ensuring enough head-room for page splits during steady ingest
CREATE INDEX REPO_RV_IND1 ON REPO_RECORD_VECTOR (
    ref_valueid
)
PCTFREE 20
MINPCTUSED 80@

-- Relevant when deleting a child, validating schema, adding a composite
CREATE INDEX REPO_RV_IND2 ON REPO_RECORD_VECTOR (
    valueid, ref_attrid
)@


---------------------------------------------------------------
-- The log
--
CREATE TABLE REPO_LOG (
    TENANTID  INT       NOT NULL,
    UNITID    BIGINT    NOT NULL,
    UNITVER   INTEGER   NOT NULL,
    EVENT     INT       NOT NULL,
    LOGENTRY  VARCHAR(256) NOT NULL,
    LOGTIME   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
)@

CREATE INDEX REPO_LOG_IND1
    ON REPO_LOG (TENANTID, UNITID)@



---------------------------------------------------------------
-- Unit locks
--
CREATE TABLE REPO_LOCK (
    TENANTID INT        NOT NULL,
    UNITID   BIGINT     NOT NULL,
    LOCKID   BIGINT GENERATED ALWAYS AS IDENTITY,

    PURPOSE  VARCHAR(256)       NOT NULL,
    LOCKTYPE INT        NOT NULL,
    EXPIRE   TIMESTAMP,
    LOCKTIME TIMESTAMP  NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT REPO_LOCK_PK
       PRIMARY KEY (TENANTID, UNITID, LOCKID),
    CONSTRAINT REPO_LOCK_UNIT_EXISTS
       FOREIGN KEY (TENANTID, UNITID) REFERENCES REPO_UNIT_KERNEL (TENANTID, UNITID) ON DELETE CASCADE
)@


----------------------------------------------------------------
-- Associations functionality
--
CREATE TABLE REPO_INTERNAL_ASSOC (
     TENANTID      INT       NOT NULL,
     UNITID        BIGINT    NOT NULL,
     ASSOCTYPE     INT       NOT NULL,
     ASSOCTENANTID INT       NOT NULL,
     ASSOCUNITID   BIGINT    NOT NULL,
     CREATED       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

     CONSTRAINT REPO_INTERNAL_ASSOC_PK
         PRIMARY KEY (TENANTID, UNITID, ASSOCTYPE, ASSOCTENANTID, ASSOCUNITID),
     CONSTRAINT REPO_IA_LEFT_UNIT_EXISTS
         FOREIGN KEY (TENANTID, UNITID) REFERENCES REPO_UNIT_KERNEL (TENANTID, UNITID) ON DELETE CASCADE,
     CONSTRAINT REPO_IA_RIGHT_UNIT_EXISTS
         FOREIGN KEY (ASSOCTENANTID, ASSOCUNITID) REFERENCES REPO_UNIT_KERNEL (TENANTID, UNITID) ON DELETE CASCADE
)@

CREATE INDEX REPO_IASSOC_IDX1
    ON REPO_INTERNAL_ASSOC (ASSOCTYPE, ASSOCTENANTID, ASSOCUNITID)@

CREATE INDEX REPO_IASSOC_IDX2
    ON REPO_INTERNAL_ASSOC (TENANTID, UNITID, ASSOCTYPE)@

CREATE TABLE REPO_EXTERNAL_ASSOC (
    TENANTID    INT       NOT NULL,
    UNITID      BIGINT    NOT NULL,
    ASSOCTYPE   INT       NOT NULL,
    ASSOCSTRING VARCHAR(256) NOT NULL,
    CREATED     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT REPO_EXTERNAL_ASSOC_PK
        PRIMARY KEY (TENANTID, UNITID, ASSOCTYPE, ASSOCSTRING),
    CONSTRAINT REPO_EA_LEFT_UNIT_EXISTS
        FOREIGN KEY (TENANTID, UNITID) REFERENCES REPO_UNIT_KERNEL (TENANTID, UNITID) ON DELETE CASCADE
)@

CREATE INDEX REPO_EASSOC_IDX1
    ON REPO_EXTERNAL_ASSOC (ASSOCTYPE, ASSOCSTRING)@

CREATE INDEX REPO_EASSOC_IDX2
    ON REPO_EXTERNAL_ASSOC (TENANTID, UNITID, ASSOCTYPE)@

--#SET TERMINATOR ;
