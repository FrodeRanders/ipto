--#SET TERMINATOR @

------------------------------------------------------------
-- Sanity check :)
------------------------------------------------------------

SELECT name, value
FROM sysibmadm.dbcfg
WHERE name IN ('codeset','codepage')@

------------------------------------------------------------
-- 1.  SCHEMA & TABLES
------------------------------------------------------------
CREATE SCHEMA REPO AUTHORIZATION REPO@
SET CURRENT SCHEMA REPO@

------------------------------------------------------------
-- Tenants
------------------------------------------------------------
CREATE TABLE REPO_TENANT
(
    TENANTID    INT           NOT NULL,
    NAME        VARCHAR(256)  NOT NULL,
    DESCRIPTION CLOB(1 M),
    CREATED     TIMESTAMP     NOT NULL DEFAULT CURRENT TIMESTAMP,
    CONSTRAINT REPO_TENANT_PK PRIMARY KEY (TENANTID),
    CONSTRAINT REPO_TENANT_NAME_UQ UNIQUE (NAME)
)@

------------------------------------------------------------
-- Unit entities
------------------------------------------------------------
CREATE TABLE REPO_UNIT_KERNEL
(
    TENANTID INT                 NOT NULL,
    UNITID   BIGINT GENERATED BY DEFAULT AS IDENTITY,
    CORRID   CHAR(36)            NOT NULL,
    STATUS   INT                 NOT NULL DEFAULT 30,
    LASTVER  INT                 NOT NULL DEFAULT 1,
    CREATED  TIMESTAMP           NOT NULL DEFAULT CURRENT TIMESTAMP,
    CONSTRAINT REPO_UNIT_KERNEL_PK PRIMARY KEY (TENANTID, UNITID),
    CONSTRAINT REPO_UNIT_KERNEL_CORRID_UQ UNIQUE (CORRID),
    CONSTRAINT REPO_UNIT_KERNEL_TENANT_FK FOREIGN KEY (TENANTID)
        REFERENCES REPO_TENANT (TENANTID)
)@

CREATE INDEX REPO_UK_IND1
    ON REPO_UNIT_KERNEL (TENANTID, UNITID, STATUS, CREATED DESC)@

CREATE INDEX REPO_UK_IND2
    ON REPO_UNIT_KERNEL (TENANTID, UNITID, LASTVER)@



CREATE TABLE REPO_UNIT_VERSION (
    TENANTID     INT        NOT NULL,
    UNITID       BIGINT     NOT NULL,
    UNITVER      INTEGER    NOT NULL,

    UNITNAME     VARCHAR(255),
    MODIFIED     TIMESTAMP  NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT REPO_UNIT_VERSION_PK
        PRIMARY KEY (TENANTID, UNITID, UNITVER),
    CONSTRAINT REPO_UNIT_VERSION_KRNL_EXISTS
        FOREIGN KEY (TENANTID, UNITID) REFERENCES REPO_UNIT_KERNEL (TENANTID, UNITID) ON DELETE CASCADE
)@

CREATE INDEX REPO_UV_IND1
    ON REPO_UNIT_VERSION (TENANTID, UNITID, UNITVER, MODIFIED)@

CREATE INDEX repo_uv_ind2
    ON REPO_UNIT_VERSION (TENANTID, UNITNAME, UNITID, UNITVER)@

------------------------------------------------------------
-- Attribute catalogue
------------------------------------------------------------
CREATE TABLE REPO_NAMESPACE
(
    ALIAS     VARCHAR(128) NOT NULL,
    NAMESPACE VARCHAR(512) NOT NULL,
    CONSTRAINT REPO_NAMESPACE_PK PRIMARY KEY (ALIAS, NAMESPACE)
)@

CREATE TABLE REPO_ATTRIBUTE
(
    ATTRID      INT             NOT NULL,
    QUALNAME    VARCHAR(512)    NOT NULL,
    ATTRNAME    VARCHAR(256)    NOT NULL,
    ATTRTYPE    INT             NOT NULL,
    SCALAR      BOOLEAN         NOT NULL DEFAULT FALSE,
    CREATED     TIMESTAMP       NOT NULL DEFAULT CURRENT TIMESTAMP,
    CONSTRAINT  REPO_ATTRIBUTE_PK PRIMARY KEY (ATTRID),
    CONSTRAINT  REPO_ATTRIBUTE_QUAL_UQ UNIQUE (QUALNAME),
    CONSTRAINT  REPO_ATTRIBUTE_NAME_UQ UNIQUE (ATTRNAME)
)@

CREATE TABLE REPO_ATTRIBUTE_DESCRIPTION
(
    ATTRID      INT         NOT NULL,
    LANG        CHAR(2)     NOT NULL DEFAULT 'SE',
    ALIAS       VARCHAR(256)NOT NULL,
    DESCRIPTION CLOB(1 M),
    CONSTRAINT  REPO_ATTR_DESC_PK PRIMARY KEY (ATTRID, LANG),
    CONSTRAINT  REPO_ATTR_DESC_ATTR_FK FOREIGN KEY (ATTRID)
        REFERENCES REPO_ATTRIBUTE (ATTRID)
)@

------------------------------------------------------------
-- Attribute value instances (1 per attribute within a unit)
------------------------------------------------------------
CREATE TABLE REPO_ATTRIBUTE_VALUE
(
    TENANTID INT     NOT NULL,
    UNITID   BIGINT  NOT NULL,
    ATTRID   INT     NOT NULL,
    VALUEID  BIGINT  GENERATED BY DEFAULT AS IDENTITY,
    CONSTRAINT REPO_ATTRIBUTE_VALUE_PK PRIMARY KEY (TENANTID, UNITID, ATTRID),
    CONSTRAINT REPO_ATTRIBUTE_VALUE_UQ UNIQUE (VALUEID),
    CONSTRAINT REPO_AV_ATTR_FK  FOREIGN KEY (ATTRID)
        REFERENCES REPO_ATTRIBUTE (ATTRID),
    CONSTRAINT REPO_AV_UNIT_FK  FOREIGN KEY (TENANTID, UNITID)
        REFERENCES REPO_UNIT_KERNEL (TENANTID, UNITID) ON DELETE CASCADE
)@

CREATE INDEX REPO_AV_IND1 ON REPO_ATTRIBUTE_VALUE (ATTRID)@

------------------------------------------------------------
-- Unit templates (metadata)
------------------------------------------------------------
CREATE TABLE REPO_UNIT_TEMPLATE
(
    TEMPLATEID INT          NOT NULL,
    NAME       VARCHAR(256) NOT NULL,
    CONSTRAINT REPO_UNIT_TEMPLATE_PK PRIMARY KEY (TEMPLATEID),
    CONSTRAINT REPO_UNIT_TEMPLATE_NAME_UQ UNIQUE (NAME)
)@

CREATE TABLE REPO_TEMPLATE_ELEMENTS
(
    TEMPLATEID INT          NOT NULL,
    ATTRID     INT          NOT NULL,
    ALIAS      VARCHAR(256) NOT NULL,
    IDX        INT          NOT NULL,
    CONSTRAINT REPO_TEMPLATE_ELEM_PK PRIMARY KEY (TEMPLATEID, ATTRID),
    CONSTRAINT REPO_TEMPLATE_ELEM_TMP_FK FOREIGN KEY (TEMPLATEID)
        REFERENCES REPO_UNIT_TEMPLATE (TEMPLATEID)
)@

------------------------------------------------------------
-- Record template (nested structures)
------------------------------------------------------------
CREATE TABLE REPO_RECORD_TEMPLATE
(
    RECORD_ATTRID INT NOT NULL,
    IDX           INT NOT NULL,
    CHILD_ATTRID  INT NOT NULL,
    ALIAS         VARCHAR(256),
    REQUIRED      BOOLEAN NOT NULL DEFAULT FALSE,
    CONSTRAINT REPO_RECORD_TEMPLATE_PK PRIMARY KEY (RECORD_ATTRID, IDX),
    CONSTRAINT REPO_RECORD_TEMPLATE_ATTR_FK
        FOREIGN KEY (RECORD_ATTRID) REFERENCES REPO_ATTRIBUTE (ATTRID)
)@

------------------------------------------------------------
-- Vector tables (seven primitive types + record)
------------------------------------------------------------
CREATE TABLE REPO_STRING_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VAL     VARCHAR(512),
    CONSTRAINT REPO_STRING_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_SV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE INDEX REPO_SV_IDX1 ON REPO_STRING_VECTOR (LOWER(VAL))@

CREATE INDEX REPO_SV_IDX2 ON REPO_STRING_VECTOR
    ( VALUEID, LOWER(VAL) )@

CREATE TABLE REPO_TIME_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VAL     TIMESTAMP,
    CONSTRAINT REPO_TIME_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_TV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE INDEX REPO_TV_IDX1 ON REPO_TIME_VECTOR (VAL)@

CREATE TABLE REPO_INTEGER_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VAL     INT,
    CONSTRAINT REPO_INT_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_IV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE TABLE REPO_LONG_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VAL     BIGINT,
    CONSTRAINT REPO_LONG_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_LV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE TABLE REPO_DOUBLE_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VAL     DOUBLE,
    CONSTRAINT REPO_DOUBLE_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_DV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE TABLE REPO_BOOLEAN_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VAL     BOOLEAN,
    CONSTRAINT REPO_BOOL_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_BV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE TABLE REPO_DATA_VECTOR
(
    VALUEID BIGINT NOT NULL,
    IDX     INT    NOT NULL DEFAULT 0,
    VAL     BLOB(1 M),
    CONSTRAINT REPO_DATA_VECTOR_PK PRIMARY KEY (VALUEID, IDX),
    CONSTRAINT REPO_DAV_VALUE_FK FOREIGN KEY (VALUEID)
        REFERENCES REPO_ATTRIBUTE_VALUE (VALUEID) ON DELETE CASCADE
)@

CREATE TABLE REPO_RECORD_VECTOR (
    valueid     BIGINT NOT NULL,           -- parent value vector
    idx         INT    NOT NULL DEFAULT 0, -- position within parent

    ref_attrid  INT    NOT NULL,
    ref_valueid BIGINT NULL,               -- initially null when first written, later updated

    CONSTRAINT REPO_RECORD_VECTOR_PK
        PRIMARY KEY (valueid, idx),
    CONSTRAINT REPO_RECORD_VEC_PARENT_EX
        FOREIGN KEY (valueid) REFERENCES REPO_ATTRIBUTE_VALUE(valueid) ON DELETE CASCADE,
    CONSTRAINT REPO_RECORD_VEC_CHILD_EX
        FOREIGN KEY (ref_valueid) REFERENCES REPO_ATTRIBUTE_VALUE(valueid) ON DELETE CASCADE
)@


-- Relevant when resolving placeholders (child -> parent),
-- i.e. when querying "WHERE ref_valueid = ?child?"
-- A fill factor of 80-90% is a reasonable starting point for ensuring enough head-room for page splits during steady ingest
CREATE INDEX REPO_RV_IND1 ON REPO_RECORD_VECTOR (
    ref_valueid
)
PCTFREE 20
MINPCTUSED 80@

-- Relevant when deleting a child, validating schema, adding a composite
CREATE INDEX REPO_RV_IND2 ON REPO_RECORD_VECTOR (
    valueid, ref_attrid
)@

--#SET TERMINATOR ;
